<!doctype html>
<html lang="ja">
<head>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>業務用MP3アップローダー & MR32プレーヤー</title>
  <style>
    body {font-family: "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; color:#222;}
    header {background:#2c3e50; color:#fff; padding:12px 24px; font-size:18px; font-weight:bold;}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    h1{font-size:18px;margin-bottom:12px;color:#2c3e50}
    .card{background:#fff;border-radius:4px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:16px;border:1px solid #ddd}
    .upload-area{border:2px dashed #aaa;padding:24px;border-radius:4px;text-align:center;cursor:pointer;color:#555}
    .upload-area.dragover{background:#eef3fa}
    input[type=file]{display:none}
    .btn{background:#2c3e50;color:white;padding:8px 16px;border-radius:4px;border:0;cursor:pointer}
    .btn:hover{background:#1a242f}
    .list{margin-top:12px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
    .meta{flex:1; margin-right:16px}
    .title{font-weight:500}
    .small{font-size:12px;color:#666}
    .progress{height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin-top:8px}
    .progress > i{display:block;height:100%;width:0;background:#2c3e50}
    audio{width:260px}
    footer{font-size:12px;color:#999;margin-top:24px;text-align:center}
    /* MR32フッタープレーヤー */
    .mr32-player {position:fixed;bottom:0;left:0;width:100%;background:#1c1c1c;color:#fff;padding:8px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 -2px 6px rgba(0,0,0,0.3);}
    .mr32-left, .mr32-center, .mr32-right{display:flex;align-items:center;}
    .mr32-btn{background:#333;color:#fff;border:none;padding:4px 8px;margin:0 4px;cursor:pointer;border-radius:2px}
    .mr32-btn:hover{background:#555}
    .mr32-title{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:300px;margin:0 8px;}
    .mr32-progress{flex:1;height:4px;background:#444;margin:0 8px;position:relative;border-radius:2px}
    .mr32-progress-bar{height:100%;width:0;background:#2c3e50;border-radius:2px}
  </style>
</head>
<body>
<header>MP3 アップロード & MR32プレーヤー</header>
<div class="wrap">
  <div class="card">
    <h1>ファイル登録</h1>
    <input id="titleInput" type="text" placeholder="タイトルを入力 (任意)" style="width:100%;margin-bottom:8px;padding:4px;border:1px solid #ccc;border-radius:4px" />
    <label id="drop" class="upload-area">
      <strong>ここにMP3をドラッグ＆ドロップ</strong>
      <div class="small">または <button class="btn" id="pick">ファイルを選択</button></div>
      <input id="file" type="file" accept="audio/*,audio/mpeg" />
    </label>
    <div id="uploadStatus"></div>
  </div>

  <div class="card">
    <h1>登録済みトラック</h1>
    <div id="tracks" class="list"></div>
  </div>
</div>

<div class="mr32-player">
  <div class="mr32-left">
    <button class="mr32-btn" id="prevBtn">◀</button>
    <button class="mr32-btn" id="playBtn">▶</button>
    <button class="mr32-btn" id="nextBtn">▶▶</button>
  </div>
  <div class="mr32-center">
    <div class="mr32-title" id="currentTitle">-</div>
    <div class="mr32-progress"><div class="mr32-progress-bar" id="progressBar"></div></div>
  </div>
  <div class="mr32-right">
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" />
  </div>
</div>

<footer>※ Firebase Firestore & Storage が必要です。</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';
import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';

const firebaseConfig = {
  apiKey: "AIzaSyCzZnkm0Cl5D0RmsCSpogANEY5uhDLwF8w",
  authDomain: "mp3player-7a205.firebaseapp.com",
  databaseURL: "https://mp3player-7a205-default-rtdb.firebaseio.com",
  projectId: "mp3player-7a205",
  storageBucket: "mp3player-7a205.firebasestorage.app",
  messagingSenderId: "339480615184",
  appId: "1:339480615184:web:bd37f04a2d1e864d046d95",
  measurementId: "G-1MZPR8DJ6K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const analytics = getAnalytics(app);

const fileInput = document.getElementById('file');
const pickBtn = document.getElementById('pick');
const drop = document.getElementById('drop');
const uploadStatus = document.getElementById('uploadStatus');
const tracksEl = document.getElementById('tracks');
const titleInput = document.getElementById('titleInput');

pickBtn.addEventListener('click', (e)=>{e.preventDefault(); fileInput.click();});
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove('dragover');}));
drop.addEventListener('drop', (e)=>{const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
fileInput.addEventListener('change',(e)=>{const f=e.target.files?.[0]; if(f) handleFile(f);});

function setStatus(msg){uploadStatus.textContent=msg;}

async function handleFile(file){
  if(!file) return;
  if(!file.type.startsWith('audio')) { alert('音声ファイルを選択してください'); return; }
  const title = titleInput.value.trim() || file.name;
  setStatus('アップロード中...');
  const id = Date.now().toString();
  const ext = file.name.split('.').pop();
  const path = `tracks/${id}.${ext}`;
  const sRef = storageRef(storage, path);
  const uploadTask = uploadBytesResumable(sRef, file);

  uploadTask.on('state_changed', snapshot=>{
    const pct = Math.round(snapshot.bytesTransferred/snapshot.totalBytes*100);
    setStatus(`アップロード ${pct}%`);
  }, err=>{console.error(err); setStatus('アップロード失敗');}, async ()=>{
    const url = await getDownloadURL(uploadTask.snapshot.ref);
    await addDoc(collection(db,'tracks'),{title,name:file.name,size:file.size,url,path,createdAt:serverTimestamp()});
    setStatus('アップロード完了');
    titleInput.value='';
  });
}

let trackList=[];
let currentIndex=-1;
const audioPlayer=new Audio();
const currentTitle=document.getElementById('currentTitle');
const progressBar=document.getElementById('progressBar');
const playBtn=document.getElementById('playBtn');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const volumeSlider=document.getElementById('volumeSlider');

volumeSlider.value=1;
audioPlayer.volume=1;
volumeSlider.addEventListener('input',()=>{audioPlayer.volume=volumeSlider.value;});

playBtn.addEventListener('click',()=>{if(audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause();});
prevBtn.addEventListener('click',()=>{if(trackList.length){currentIndex=(currentIndex-1+trackList.length)%trackList.length; playTrack(currentIndex);}});
nextBtn.addEventListener('click',()=>{if(trackList.length){currentIndex=(currentIndex+1)%trackList.length; playTrack(currentIndex);}});
audioPlayer.addEventListener('timeupdate',()=>{if(audioPlayer.duration){progressBar.style.width=(audioPlayer.currentTime/audioPlayer.duration*100)+'%';}});
audioPlayer.addEventListener('ended',()=>{nextBtn.click();});

function playTrack(index){
  const track=trackList[index];
  if(!track) return;
  audioPlayer.src=track.url;
  audioPlayer.play();
  currentTitle.textContent=track.title;
  currentIndex=index;
}

const q=query(collection(db,'tracks'),orderBy('createdAt','desc'));
onSnapshot(q,(snap)=>{
  tracksEl.innerHTML='';
  trackList=[];
  snap.forEach(docSnap=>{
    const data=docSnap.data();
    const docId=docSnap.id;
    trackList.push({id:docId,...data});
    const item=document.createElement('div');
    item.className='item';
    const meta=document.createElement('div'); meta.className='meta';
    const titleDiv=document.createElement('div'); titleDiv.className='title'; titleDiv.textContent=data.title||data.name||'無題';
    const smallDiv=document.createElement('div'); smallDiv.className='small';
    const date=data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '';
    smallDiv.textContent=`${date} · ${Math.round((data.size||0)/1024)} KB`;
    meta.appendChild(titleDiv); meta.appendChild(smallDiv);
    const audioWrap=document.createElement('div');
    const playSingleBtn=document.createElement('button'); playSingleBtn.textContent='再生'; playSingleBtn.className='mr32-btn';
    playSingleBtn.addEventListener('click',()=>{playTrack(trackList.findIndex(t=>t.id===docId));});
    const deleteBtn=document.createElement('button'); deleteBtn.textContent='削除'; deleteBtn.className='mr32-btn';
    deleteBtn.addEventListener('click',async ()=>{
      if(confirm('本当に削除しますか？')){
        await deleteObject(storageRef(storage,data.path));
        await deleteDoc(doc(db,'tracks',docId));
      }
    });
    audioWrap.appendChild(playSingleBtn); audioWrap.appendChild(deleteBtn);
    item.appendChild(meta); item.appendChild(audioWrap);
    tracksEl.appendChild(item);
  });
});
</script>
</body>
</html>
